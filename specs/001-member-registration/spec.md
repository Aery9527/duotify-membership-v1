# 功能規格書：會員註冊流程

**Feature Branch**: `001-member-registration`  
**Created**: 2025-10-19  
**Status**: Draft  
**Input**: User description: "會員註冊流程：使用者透過填寫身分證字號、姓名、E-Mail、密碼完成註冊，系統寄送 6 位數驗證碼進行 E-Mail 驗證"

**⚠️ LANGUAGE REQUIREMENT**: This specification MUST be written in Traditional Chinese (zh-TW) per Constitution Principle V.

## Clarifications

### Session 2025-10-19

- Q: 驗證碼錯誤嘗試次數限制機制 → A: 限制 3 次嘗試，超過後帳號暫時鎖定 10 分鐘
- Q: 重新寄送驗證碼時舊驗證碼的處理 → A: 舊驗證碼立即失效，只有最新的驗證碼有效；限制重發次數（每小時最多 3 次），超過則拒絕重發
- Q: 姓名欄位特殊字元處理規則 → A: 只允許中文與英文字母，不允許任何空格或符號
- Q: 併發註冊時身分證字號唯一性保證機制 → A: 資料庫唯一索引（UNIQUE constraint）+ 應用層重複檢查
- Q: 未驗證使用者的功能限制範圍 → A: 限制進階功能（例如付費內容、個人化設定、社交互動），允許基本瀏覽

## 使用者情境與測試 *(必填)*

### User Story 1 - 基本註冊流程 (Priority: P1)

新使用者造訪平台，透過填寫個人資料（身分證字號、姓名、E-Mail、密碼）完成帳號建立，系統建立會員帳戶並寄送驗證碼至使用者的 E-Mail 信箱。

**為何優先**: 這是整個會員系統的核心基礎，沒有註冊功能就無法建立使用者帳戶，是系統運作的必要條件。

**獨立測試**: 可透過填寫註冊表單並送出，驗證系統能成功建立會員帳號並寄送驗證碼 E-Mail，即使未完成驗證仍可登入系統（功能受限）。

**驗收情境**:

1. **Given** 使用者尚未註冊帳號，**When** 使用者填寫有效的身分證字號、姓名、E-Mail、符合規則的密碼並送出，**Then** 系統建立會員帳戶並顯示「註冊成功，請至信箱收取驗證碼」訊息
2. **Given** 使用者輸入已註冊過的身分證字號，**When** 使用者嘗試送出註冊表單，**Then** 系統顯示「此身分證字號已註冊」錯誤訊息並阻止註冊
3. **Given** 兩個使用者同時使用相同身分證字號送出註冊請求，**When** 系統處理併發請求，**Then** 只有一個請求成功建立帳戶，另一個請求收到「此身分證字號已註冊」錯誤訊息
4. **Given** 使用者輸入不符合格式的身分證字號，**When** 使用者嘗試送出，**Then** 系統顯示「身分證字號格式錯誤」訊息
5. **Given** 使用者輸入的姓名包含空格或特殊字元（非中文或英文字母），**When** 使用者嘗試送出，**Then** 系統顯示「姓名只能包含中文或英文字母」錯誤訊息
6. **Given** 使用者輸入的密碼少於 8 碼或超過 20 碼，**When** 使用者嘗試送出，**Then** 系統顯示「密碼長度必須在 8-20 碼之間」錯誤訊息
7. **Given** 使用者輸入的密碼未包含英文大小寫與數字，**When** 使用者嘗試送出，**Then** 系統顯示「密碼必須包含英文大小寫與數字」錯誤訊息
8. **Given** 使用者送出註冊表單後，**When** 系統處理完成，**Then** 註冊頁面不會自動導向至登入頁面

---

### User Story 2 - E-Mail 驗證流程 (Priority: P2)

已註冊但尚未驗證 E-Mail 的使用者，收到內含 6 位數驗證碼的 E-Mail（有效期限 5 分鐘），在驗證頁面手動輸入驗證碼完成帳號啟用，解鎖所有平台功能。

**為何優先**: E-Mail 驗證是確保使用者身分真實性的重要機制，完成驗證後才能使用完整功能，是註冊流程的第二優先項目。

**獨立測試**: 可透過已註冊但未驗證的帳號登入後，在驗證頁面輸入正確的 6 位數驗證碼，驗證系統能正確啟用帳號並解鎖功能限制。

**驗收情境**:

1. **Given** 使用者收到驗證碼，**When** 使用者在 5 分鐘內輸入正確的 6 位數驗證碼，**Then** 系統啟用帳號並顯示「驗證成功」訊息，帳號所有功能解鎖
2. **Given** 使用者收到驗證碼，**When** 使用者在 5 分鐘後輸入驗證碼，**Then** 系統顯示「驗證碼已過期」錯誤訊息
3. **Given** 使用者在驗證頁面，**When** 使用者輸入錯誤的驗證碼，**Then** 系統顯示「驗證碼錯誤」訊息並允許重新輸入
4. **Given** 使用者已輸入錯誤驗證碼 3 次，**When** 使用者再次嘗試輸入，**Then** 系統顯示「錯誤次數過多，帳號已暫時鎖定 10 分鐘」訊息並禁止繼續嘗試
5. **Given** 使用者要求重新寄送驗證碼，**When** 系統產生新驗證碼，**Then** 舊驗證碼立即失效，只有新驗證碼可用於驗證
6. **Given** 使用者在 1 小時內已重發驗證碼 3 次，**When** 使用者再次要求重發，**Then** 系統拒絕重發並顯示「重發次數已達上限，請稍後再試」訊息
7. **Given** 使用者尚未完成 E-Mail 驗證，**When** 使用者使用帳號密碼登入，**Then** 系統允許登入但顯示「帳號未驗證，部分功能受限」提示訊息

---

### User Story 3 - 未驗證帳號登入 (Priority: P3)

已註冊但尚未完成 E-Mail 驗證的使用者，可以使用帳號密碼登入系統，能夠使用基本瀏覽功能，但進階功能（付費內容、個人化設定、社交互動等）受到限制，直到完成 E-Mail 驗證後才能使用完整功能。

**為何優先**: 這是提供使用者彈性的設計，讓使用者即使尚未驗證 E-Mail 也能先體驗部分功能，但優先級低於核心註冊與驗證流程。

**獨立測試**: 可透過已註冊但未驗證的帳號登入系統，驗證系統允許登入並正確顯示功能限制提示，且確認進階功能無法使用，但基本瀏覽功能可正常運作。

**驗收情境**:

1. **Given** 使用者已註冊但未完成 E-Mail 驗證，**When** 使用者輸入正確的帳號密碼登入，**Then** 系統允許登入並顯示「您的帳號尚未完成 E-Mail 驗證」通知
2. **Given** 未驗證的使用者已登入，**When** 使用者嘗試使用進階功能（付費內容、個人化設定、社交互動），**Then** 系統顯示「此功能需要完成 E-Mail 驗證」訊息並導向驗證頁面
3. **Given** 未驗證的使用者已登入，**When** 使用者瀏覽基本內容，**Then** 系統允許正常瀏覽不受限制
4. **Given** 未驗證的使用者在驗證頁面輸入正確驗證碼，**When** 驗證成功後，**Then** 系統立即解除功能限制，無需重新登入

---

### 邊界案例

- 使用者在註冊時填寫無效的 E-Mail 格式（例如缺少 @ 符號），系統如何處理？
- 帳號鎖定期間使用者嘗試登入時，系統如何處理？鎖定 10 分鐘後是否自動解鎖？
- 使用者在驗證碼重發冷卻時間內（1 小時內已重發 3 次）嘗試登入或其他操作時，是否受到影響？

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系統必須提供註冊表單，包含身分證字號、姓名、E-Mail、密碼等欄位
- **FR-001a**: 系統必須驗證姓名只包含中文或英文字母，不允許空格、數字或特殊字元
- **FR-002**: 系統必須驗證身分證字號格式符合台灣身分證字號規則（1 碼英文字母 + 9 碼數字）
- **FR-003**: 系統必須檢查身分證字號是否已被註冊，防止重複註冊
- **FR-003a**: 資料庫必須在身分證字號欄位設定唯一索引（UNIQUE constraint）確保資料層級的唯一性
- **FR-003b**: 應用層必須在建立帳戶前先查詢身分證字號是否存在，提供友善的錯誤訊息
- **FR-003c**: 系統必須正確處理資料庫唯一約束違反錯誤，轉換為使用者可理解的錯誤訊息
- **FR-004**: 系統必須驗證密碼長度為 8-20 碼，且必須包含英文大小寫與數字
- **FR-005**: 系統必須驗證 E-Mail 格式正確（包含 @ 符號且符合 E-Mail 格式規範）
- **FR-006**: 系統必須在使用者送出註冊表單後建立會員帳戶（狀態為未驗證）
- **FR-007**: 系統必須產生 6 位數的隨機驗證碼，有效期限為 5 分鐘
- **FR-008**: 系統必須寄送包含 6 位數驗證碼的 E-Mail 至使用者註冊的信箱
- **FR-008a**: 系統必須提供重新寄送驗證碼功能
- **FR-008b**: 系統必須在產生新驗證碼時立即使舊驗證碼失效
- **FR-008c**: 系統必須限制驗證碼重發次數為每小時最多 3 次
- **FR-008d**: 系統必須記錄驗證碼重發時間戳記用於計算冷卻時間
- **FR-009**: 系統必須提供驗證碼輸入頁面，讓使用者手動輸入 6 位數驗證碼
- **FR-010**: 系統必須驗證使用者輸入的驗證碼是否正確且未過期
- **FR-010a**: 系統必須記錄驗證碼錯誤嘗試次數，當達到 3 次後暫時鎖定帳號 10 分鐘
- **FR-010b**: 系統必須在帳號鎖定期間拒絕驗證碼輸入並顯示鎖定訊息
- **FR-010c**: 系統必須在鎖定期限結束後自動解鎖帳號並重置錯誤嘗試次數
- **FR-011**: 系統必須在驗證成功後將帳號狀態更新為已驗證
- **FR-012**: 系統必須允許未驗證的使用者使用帳號密碼登入
- **FR-013**: 系統必須標示未驗證使用者並限制其使用進階功能
- **FR-013a**: 未驗證使用者可使用基本瀏覽功能（例如瀏覽公開內容、查看列表）
- **FR-013b**: 未驗證使用者不可使用付費內容存取功能
- **FR-013c**: 未驗證使用者不可使用個人化設定功能（例如偏好設定、個人資料編輯）
- **FR-013d**: 未驗證使用者不可使用社交互動功能（例如評論、按讚、分享）
- **FR-013e**: 系統必須在未驗證使用者嘗試使用受限功能時，顯示明確的提示訊息並提供驗證入口
- **FR-014**: 系統必須在使用者完成驗證後自動解除功能限制
- **FR-015**: 註冊流程必須為單向流程，不提供返回上一步功能
- **FR-016**: 系統完成註冊後不得自動登入使用者

### 關鍵實體

- **會員帳戶（Member Account）**: 代表註冊使用者的帳戶資訊，包含身分證字號（唯一識別）、姓名、E-Mail、密碼（加密儲存）、帳號狀態（已驗證/未驗證）、建立時間、鎖定狀態（未鎖定/已鎖定）、鎖定到期時間
- **驗證碼（Verification Code）**: 用於 E-Mail 驗證的 6 位數隨機碼，包含驗證碼數值、關聯的會員帳戶、產生時間、過期時間（5 分鐘）、使用狀態（未使用/已使用/已過期/已失效）、錯誤嘗試次數
- **驗證碼重發記錄（Verification Code Resend Log）**: 記錄驗證碼重發歷史，包含關聯的會員帳戶、重發時間戳記，用於實施每小時 3 次的重發限制

## 成功標準 *(必填)*

### 可衡量成果

- **SC-001**: 使用者能在 3 分鐘內完成註冊表單填寫並送出
- **SC-002**: 90% 的使用者能在第一次嘗試時成功輸入符合規則的密碼
- **SC-003**: 使用者在送出註冊後 30 秒內收到驗證碼 E-Mail
- **SC-004**: 85% 的使用者能在 5 分鐘有效期限內完成 E-Mail 驗證
- **SC-005**: 系統能正確阻止 100% 的重複身分證字號註冊嘗試
- **SC-006**: 未驗證使用者登入後，能清楚理解帳號狀態與功能限制

### 效能標準

根據憲法要求（`.specify/memory/constitution.md`）：

- **SC-P01**: 註冊表單送出後，系統回應時間在 p95 百分位數下少於 200ms
- **SC-P02**: 驗證碼輸入驗證的回應時間在 p95 百分位數下少於 100ms
- **SC-P03**: 系統能同時處理 1,000+ 個並發註冊請求而不降低效能
- **SC-P04**: 身分證字號重複檢查的查詢效能在 p95 百分位數下少於 50ms

### 品質標準

- **SC-Q01**: 程式碼覆蓋率維持 80% 以上
- **SC-Q02**: 所有 API 回應遵循標準 JSON 結構
- **SC-Q03**: 所有輸入驗證完整且錯誤訊息具體可操作
- **SC-Q04**: 依賴套件中無高風險或嚴重安全漏洞
- **SC-Q05**: 密碼必須使用業界標準加密演算法儲存（例如 bcrypt）
- **SC-Q06**: 身分證字號等敏感資料必須妥善保護，符合個資法規範

